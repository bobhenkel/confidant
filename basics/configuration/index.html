<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Confidant: Configuration</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Source+Code+Pro">
    <link href="../../stylesheets/site-820e35f9.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
      <header id="header">
    <nav class="global-nav" role="navigation">
  <section class="wrap-container">
    <header class="global-nav-item logo-text">
      <a class="global-nav-logo" href="../../">Confidant</a>
    </header>

    <ul class="global-nav-list">
      <li class="global-nav-item">
        <a href="//twitter.com/share" class="twitter-share-button" data-text="Confidant, your secret keeper" data-via="lyft" data-count="none">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

      </li>
      <li class="global-nav-item">
        <iframe src="//ghbtns.com/github-btn.html?user=lyft&repo=confidant&type=watch" height="30" width="70" frameborder="0" scrolling="0" style="width:70px; height: 30px;" class="github-btn" allowTransparency="true"></iframe>

      </li>
      <li class="global-nav-item">
        <a class="cta-link-nav-filled" href="../install/">Docs</a>
      </li>
    </ul>
  </section>
</nav>

  </header>

  <div class="body-content-container wrap-container" role="main">
    <nav id="toc" class="sidebar" data-waypoint="sidebar">
      <div id="search" role="search">
  <form>
    <input class="st-default-search-input" id="st-default-search-input" type="search" placeholder="Search the docs">
  </form>
  <div id="st-results-container"></div>
  <script type="text/javascript">
    (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
    })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

    _st('install','pzDJ5qvukhA8YuSHzVGN','2.0.0');
  </script>
</div>

<div class="toc-block-container">
  <div class="toc-block">
    <h3 class="docs-section-heading">Basics</h3>
    <ul>
      <li class="doc-item">
        <a href="../install/">Install</a> </li>
      <li class="doc-item">
        <a href="./">Configure</a>
        </li>
      <li class="doc-item">
        <a href="../using_confidant/">Managing Secrets and Mappings</a>
        </li>
      <li class="doc-item">
        <a href="../client/">Using the Client</a>
        </li>
    </ul>
  </div>

  <div class="toc-block">
    <h3 class="docs-section-heading">Advanced</h3>
    <ul>
      <li class="doc-item">
        <a href="../../advanced/blind_secrets/">Server-blinded Secrets</a>
        </li>
      <li class="doc-item">
        <a href="../../advanced/kms_auth/">KMS Authentication</a>
        </li>
      <li class="doc-item">
        <a href="../../advanced/threat_model/">Threat Model</a>
        </li>
      <li class="doc-item">
        <a href="../../advanced/contributing/">Contributing</a>
        </li>
      <li class="doc-item">
        <a href="../../advanced/data_schema/">Data Schema</a>
        </li>
      <li class="doc-item">
        <a href="../../advanced/changelog/">Changelog</a>
        </li>
    </ul>
  </div>
  <div class="toc-block">
    <h3 class="docs-section-heading">Communication</h3>
    <ul>
      <li class="doc-item">
        <a href="../../communication/support/">Support</a>
	</li>
      <li class="doc-item">
        <a href="../../communication/security_reporting/">Security Reporting</a>
	</li>
    </ul>
  </div>
</div>

    </nav>

    <main class="main" role="main" data-waypoint="main">
      <h1 id="configuration">Configuration</h1>

<p>Confidant is primarily configured through environment variables. The list of
all available configuration options can be found in the settings.py file.</p>

<p>Prerequisites not covered by this guide:</p>

<ol>
<li>Your Google application is setup and you know your client id and secret key.</li>
</ol>

<h2 id="docker-vs-bash">Docker vs bash</h2>

<p>Note that below the format of the configuration is given in bash format for
defining and exporting environment variables. Docker environment files have a
slightly different format than bash. Here&#39;s an example of the difference:</p>

<p>In bash format:</p>

<pre><code class="bash">export MY_VARIABLE=&#39;MY_VALUE&#39;
</code></pre>

<p>In docker env file format, you don&#39;t export the variable, and the value
shouldn&#39;t be quoted, since everything after the equal sign is considered part
of the value. So, in a docker environment file, you&#39;d define the same variable
and value like this:</p>

<p>In docker format:</p>

<pre><code>MY_VARIABLE=MY_VALUE
</code></pre>

<h2 id="basic-environment-configuration">Basic environment configuration</h2>

<p>This is the minimum configuration needed to use Confidant:</p>

<pre><code class="bash"># The region our service is running in.
export AWS_DEFAULT_REGION=&#39;us-east-1&#39;
# The IAM role name of the confidant server.
export AUTH_CONTEXT=&#39;confidant-production&#39;
# The KMS key used for auth.
export AUTH_KEY=&#39;authnz-production&#39;
# The DynamoDB table name for storage.
export DYNAMODB_TABLE=&#39;confidant-production&#39;
# Auto-generate the dynamodb table.
export DYNAMODB_CREATE_TABLE=true
# Set the gevent resolver to ares; see:
#   https://github.com/surfly/gevent/issues/468
export GEVENT_RESOLVER=&#39;ares&#39;
# The KMS key used for at-rest encryption in DynamoDB.
export KMS_MASTER_KEY=&#39;confidant-production&#39;
# A long randomly generated string for CSRF protection.
# SESSION_SECRET can be loaded via SECRETS_BOOTSTRAP
export SESSION_SECRET=&#39;aBVmJA3zv6zWGjrYto135hkdox6mW2kOu7UaXIHK8ztJvT8w5O&#39;
# The IP address to listen on.
export HOST=&#39;0.0.0.0&#39;
# The port to listen on.
export PORT=&#39;80&#39;
</code></pre>

<h3 id="google-authentication-configuration">Google authentication configuration</h3>

<p>To enable Google authentication, you&#39;ll need to visit the API manager in the
Google developer console (<a href="https://console.developers.google.com">https://console.developers.google.com</a>), and create a
new project (or add credentials to an existing project, if you prefer). After
creating the project, you&#39;ll need to enable the Google+ API. After enabling the
Google+ API, you&#39;ll need to add credentials to this project. You&#39;ll want to
create OAuth client ID credentials. The application type is &#39;Web application&#39;.
The Authorized JavaScript origins is &#39;<url>/&#39;. The Authorized redirect URI is 
<code>&lt;url&gt;/v1/login</code>. Take the generated client id and consumer secret, and set
them in the settings. You&#39;ll also need to generate a long random string and set
the AUTHOMATIC_SALT setting, for CSRF protection.</p>

<pre><code class="bash"># The authentication type we&#39;ll be using for user authentication (google is the
# default)
export USER_AUTH_MODULE=&#39;google&#39;
# The client id and consumer secret from the google developer console.
# GOOGLE_OAUTH_CLIENT_ID and GOOGLE_OAUTH_CONSUMER_SECRET can be loaded via SECRETS_BOOTSTRAP
export GOOGLE_OAUTH_CLIENT_ID=&#39;123456789-abcdefghijklmnop.apps.googleusercontent.com&#39;
export GOOGLE_OAUTH_CONSUMER_SECRET=&#39;123456789abcdefghijklmnop&#39;
# A long randomly generated string used for the google OAuth2 flow.
# AUTHOMATIC_SALT can be loaded via SECRETS_BOOTSTRAP
export AUTHOMATIC_SALT=&#39;H39bfLCqLbrYrFyiJIxkK0uf12rlzvgjgo9FqOnttPXIdAAuyQ&#39;
</code></pre>

<h3 id="saml-authentication-configuration">SAML authentication configuration</h3>

<p>TODO: As of Confidant version 1.1 it&#39;s possible to use SAML as an alternative
to google authentication. We still need to document all of the options, though.
Basic documentation for each SAML option is described in the settings.py file.</p>

<h3 id="user-authentication-session-settings">User authentication session settings</h3>

<p>By default (in confidant 1.1) confidant will use itsdangerous secure cookies
for session management, with a session lifetime and maximum session lifetime. A
user&#39;s session lifetime with automatically be extended any time a user performs
any action in the interface, but the user&#39;s session lifetime can only be
extended up to the maximum session lifetime, in which they&#39;ll be required to
login again. The session lifetime and maximum session lifetime can be adjusted:</p>

<pre><code class="bash"># Session lifetime in seconds. Default is 12 hours.
export PERMANENT_SESSION_LIFETIME=&#39;43200&#39;
# Maximum session lifetime in seconds. Default is 24 hours.
export MAX_PERMANENT_SESSION_LIFETIME=&#39;86400&#39;
</code></pre>

<p>An alternative to using itsdangerous cookies is to store cookies in a redis
backend:</p>

<pre><code class="bash">export REDIS_URL=&#39;redis://localhost:6381&#39;
export PERMANENT_SESSION_LIFETIME=&#39;0&#39;
</code></pre>

<p>It&#39;s possible to use custom cookie names for both the session cookie, and for
the XSRF token cookie:</p>

<pre><code class="bash">export SESSION_COOKIE_NAME=&#39;confidant_session&#39;
export XSRF_COOKIE_NAME=&#39;XSRF-TOKEN&#39;
</code></pre>

<h3 id="disabling-credential-conflict-checks">Disabling credential conflict checks</h3>

<p>By default confidant will ensure that credentials mapped to a service don&#39;t
have any conflicting credential pair keys. These checks occur when mapping
credentials to a service, or when modifying credentials that are mapped to a
service. To disable this check:</p>

<pre><code class="bash">export IGNORE_CONFLICTS=&#39;True&#39;
</code></pre>

<h2 id="advanced-environment-configuration">Advanced environment configuration</h2>

<h3 id="statsd-metrics">statsd metrics</h3>

<p>Confidant can track some stats via statsd. By default it&#39;s set to send stats to
statsd on localhost on port 8125.</p>

<pre><code class="bash">export STATSD_HOST=&#39;mystatshost.example.com&#39;
export STATSD_PORT=&#39;8125&#39;
</code></pre>

<h3 id="sending-graphite-events">Sending graphite events</h3>

<p>Confidant can also send graphite events on secret updates or changes in service
mappings:</p>

<pre><code class="bash">export GRAPHITE_EVENT_URL=&#39;https://graphite.example.com/events/&#39;
export GRAPHITE_USERNAME=&#39;mygraphiteuser&#39;
# GRAPHITE_PASSWORD can be loaded via SECRETS_BOOTSTRAP
export GRAPHITE_PASSWORD=&#39;mylongandsupersecuregraphitepassword&#39;
</code></pre>

<h3 id="google-authentication-user-restrictions">Google authentication user restrictions</h3>

<p>It&#39;s possible to restrict access to a subset of users that authenticate
using Google authentication:</p>

<pre><code class="bash">export USERS_FILE=&#39;/etc/confidant/users.yaml&#39;
export USER_EMAIL_SUFFIX=&#39;@example.com&#39;
</code></pre>

<p>In the above configuration, Confidant will limit authentication to users with
the email domain @example.com. Additionally, Confidant will look in the
users.yaml file for a list of email addresses allowed to access Confidant.</p>

<h3 id="auth-token-lifetime">Auth token lifetime</h3>

<p>It&#39;s possible to limit the lifetime of KMS authentication tokens. By default
Confidant limits token lifetime to 60 minutes, to ensure that tokens are being
rotated. To change this, you can use the following option:</p>

<pre><code class="bash"># Limit token lifetime to 10 minutes.
export AUTH_TOKEN_MAX_LIFETIME=&#39;10&#39;
</code></pre>

<h3 id="frontend-configuration">Frontend configuration</h3>

<p>If you&#39;re using the generated, minified output in the dist directory, you
need to tell confidant to change its static folder:</p>

<pre><code class="bash">export STATIC_FOLDER=&#39;dist&#39;
</code></pre>

<p>It&#39;s possible to customize portions of the angularjs application.
Currently you can add a documentation section to the credential details view.
We&#39;d like to make more customization available. Please open a github issue with
specific customizations you&#39;d like focused on first. The custom js/css/html
will be served from a directory you specify:</p>

<pre><code class="bash">export CUSTOM_FRONTEND_DIRECTORY=&#39;/srv/confidant-static&#39;
</code></pre>

<h3 id="development-and-testing-settings">Development and testing settings</h3>

<p>There&#39;s a few settings that are meant for development or testing purposes only
and should never be used in production:</p>

<pre><code class="bash"># Disable all forms of authentication.
# NEVER USE THIS IN PRODUCTION!
export USE_AUTH=false
# Disable any use of at-rest encryption.
# NEVER USE THIS IN PRODUCTION!
export USE_ENCRYPTION=false
# Disable SSLify
# NEVER USE THIS IN PRODUCTION!
export SSLIFY=false
# Enable debug mode, which will also disable SSLify.
# NEVER USE THIS IN PRODUCTION!
export DEBUG=true
</code></pre>

<h3 id="bootstrapping-confidants-own-secrets">Bootstrapping Confidant&#39;s own secrets</h3>

<p>It&#39;s possible for confidant to load its own secrets from a KMS encrypted base64
encoded YAML dict. This dict can be generated (and decrypted) through a
confidant script:</p>

<pre><code class="bash">cd /srv/confidant
source venv/bin/activate

# Encrypt the data
python manage.py generate_secrets_bootstrap --in unencrypted_dict.yaml --out encrypted_dict.yaml.enc
export SECRETS_BOOTSTRAP=`cat encrypted_dict.yaml.enc`

# Get a decrypted output of the yaml data
python manage.py decrypt_secrets_bootstrap
</code></pre>

<h3 id="multi-account-authentication">Multi-account authentication</h3>

<p>It&#39;s possible to use confidant across multiple AWS accounts by allowing
cross-account access to the AUTH_KEY, but when you give access to the AUTH_KEY
in other accounts, you&#39;re trusting the other account&#39;s IAM policy for
generating authentication tokens for services. Confidant supports scoping
services to accounts, where you generate a KMS key for each account, for
authentication. You can configure confidant to map keys to account names:</p>

<pre><code class="bash">export SCOPED_AUTH_KEYS=&#39;{&quot;sandbox-auth-key&quot;:&quot;sandbox&quot;,&quot;primary-auth-key&quot;:&quot;primary&quot;}&#39;
</code></pre>

<p>In the above example, if a user scopes a service to the &quot;sandbox&quot; account,
it&#39;ll require authentication to use the &quot;sandbox-auth-key&quot; KMS key.</p>

<h3 id="kms-authentication-for-end-users">KMS authentication for end-users</h3>

<p>In confidant version 1.1 we introduced a new version of KMS auth that allows
user authentication in addition to service authentication. By default confidant
will only allow service authentication.</p>

<pre><code class="bash"># The alias of the KMS key being used for authentication that is specifically
# for the &#39;user&#39; role. This should not be the same key as AUTH_KEY if your
# kms token version is less than 2, as it would allow services to masquerade
#  as users.
export USER_AUTH_KEY=&#39;user-auth-key&#39;
# The maximum version of the authentication token accepted.
export KMS_MAXIMUM_TOKEN_VERSION=&#39;2&#39;
# The minimum version of the authentication token accepted. You should set this
# as high as your clients support.
export KMS_MINIMUM_TOKEN_VERSION=&#39;1&#39;
# Comma separated list of user types allowed to auth via KMS. Default is
# &#39;service&#39;.
export KMS_AUTH_USER_TYPES=&#39;user,service&#39;
</code></pre>

<h3 id="kms-grant-management">KMS grant management</h3>

<p>By default confidant will manage KMS grants automatically for services that are
created, assuming that services are directly associated with IAM roles.
Confidant services don&#39;t need to be directly associated with IAM roles, though,
since access to the services is defined either by grants on the keys, or
through IAM policy. It&#39;s possible to disable confidant&#39;s grant management. If
you disable grant managenent, you&#39;ll either need to manage KMS key grants
manually, or you&#39;ll need to manage your IAM policy for KMS.</p>

<pre><code class="bash"># Manage auth key grants for service to service authentication. Default True
export KMS_AUTH_MANAGE_GRANTS=&#39;False&#39;
</code></pre>

<h3 id="confidant-client-configuration">Confidant client configuration</h3>

<p>Confidant exposes some data to its clients via a flask endpoint. It&#39;s possible
to expose additional custom data to clients through the server&#39;s configuration:</p>

<pre><code class="bash">export CLIENT_CONFIG=&#39;{&quot;blind_keys&quot;:{&quot;us-east-1&quot;:&quot;alias/blindkey-useast1&quot;,&quot;us-west-2&quot;:&quot;alias/blindkey-uswest2&quot;},&quot;blind_cipher_type&quot;:&quot;fernet&quot;,&quot;blind_cipher_version&quot;:&quot;2&quot;,&quot;blind_store_credential_keys&quot;:true}&#39;
</code></pre>

<p>The native client, or custom clients can use this data to help configure
themselves.</p>

<h3 id="confidant-performance-settings">Confidant performance settings</h3>

<p>Confidant comes setup to perform well by default, but it&#39;s possible you may
find some of these settings too aggressive, or you may have enough clients or
services that the defaults aren&#39;t high enough.</p>

<p>The primary performance setting is for authentication token caching, and is set
to 4096. This should be set to something near your total number of clients with
unique authentication tokens. Assuming every client has a unique token, it
should be equal to greater than your number of clients. This cache avoids calls
to KMS for authentication, reducing latency and reducing likelyhood of
ratelimiting from KMS. The following configuration can adjust this:</p>

<pre><code>export KMS_AUTH_TOKEN_CACHE_SIZE=4096
</code></pre>

<p>Confidant has a couple settings for tuning pynamodb performance. By default
confidant is pretty aggressive with pynamodb timeouts, setting the default
timeout to 1s. This is to fail fast and retry, rather than waiting on a blocked
request that could be general networking failures, attempting to avoid request
pileups. If this setting is too aggressive, you can adjust it via:</p>

<pre><code>export PYNAMO_REQUEST_TIMEOUT_SECONDS=1
</code></pre>

<p>To avoid recreating connections to dynamodb on each request, we open a larger
than default number of pooled connections to dynamodb. Our default is 100. The
number of connections should be greater than or equal to the number of
concurrent requests per worker. To adjust this:</p>

<pre><code>export PYNAMO_CONNECTION_POOL_SIZE=100
</code></pre>

<p>Similar to the performance tuning for dynamodb, we also have similar tuning
settings for KMS. For both connection and read timeouts, we aggressively set
the timeout to be 1s, since we assume any request that takes this long is
related to some network failure. To adjust these settings:</p>

<pre><code>export KMS_CONNECTION_TIMEOUT=1
export KMS_READ_TIMEOUT=1
</code></pre>

<p>We also increase the default connection pool to KMS. This should be greater
than or equal to the number of concurrent requests per worker. To adjust this:</p>

<pre><code>export KMS_MAX_POOL_CONNECTIONS=100
</code></pre>

<h2 id="kms-key-policy-configuration">KMS key policy configuration</h2>

<p>Confidant needs to have special KMS key policy for both the at-rest
KMS_MASTER_KEY and the authentication AUTH_KEY.</p>

<p>Here&#39;s an example key policy for the at-rest encryption key, KMS_MASTER_KEY, assuming the
above configuration. Note the following:</p>

<ol>
<li>The &quot;Enable IAM User Permissions&quot; policy ensures that IAM users in your account
that have the proper IAM permissions can manage this key. This is here to
ensure you don&#39;t lock yourself out of the key.</li>
<li>The &quot;Allow access for Key Administrators&quot; policy ensures that a special IAM
user can manage the KMS key.</li>
<li>The &quot;Allow use of the key&quot; policy ensures that confidant can use the key.</li>
</ol>

<pre><code class="json">{
  &quot;Version&quot; : &quot;2012-10-17&quot;,
  &quot;Id&quot; : &quot;key-consolepolicy-1&quot;,
  &quot;Statement&quot; : [ {
    &quot;Sid&quot; : &quot;Enable IAM User Permissions&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:root&quot;
    },
    &quot;Action&quot; : &quot;kms:*&quot;,
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow access for Key Administrators&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:user/myadminuser&quot;
    },
    &quot;Action&quot; : [ &quot;kms:Describe*&quot;, &quot;kms:List*&quot;, &quot;kms:Create*&quot;, &quot;kms:Revoke*&quot;,
&quot;kms:Enable*&quot;, &quot;kms:Get*&quot;, &quot;kms:Disable*&quot;, &quot;kms:Delete*&quot;, &quot;kms:Put*&quot;,
&quot;kms:Update*&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow use of the key&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:role/confidant-production&quot;
    },
    &quot;Action&quot; : [ &quot;kms:Decrypt&quot;, &quot;kms:GenerateDataKey*&quot;, &quot;kms:ReEncrypt*&quot;,
&quot;kms:DescribeKey&quot;, &quot;kms:Encrypt&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  } ]
}
</code></pre>

<p>Here&#39;s an example key policy for the authentication key, AUTH_KEY, assuming the
above configuration. Note the following:</p>

<ol>
<li>The &quot;Enable IAM User Permissions&quot; policy ensures that IAM users in your account
that have the proper IAM permissions can manage this key. This is here to
ensure you don&#39;t lock yourself out of the key.</li>
<li>The &quot;Allow access for Key Administrators&quot; policy ensures that a special IAM
user can manage the KMS key.</li>
<li>The &quot;Allow use of the key&quot; policy ensures that confidant can use the key.</li>
<li>The &quot;Allow attachment of persistent resources&quot; policy ensures that confidant
can add and revoke grants for the auth key, which is necessary to give
access to context specific encrypt and decrypt calls for service IAM roles.</li>
</ol>

<pre><code class="json">{
  &quot;Version&quot; : &quot;2012-10-17&quot;,
  &quot;Id&quot; : &quot;key-consolepolicy-1&quot;,
  &quot;Statement&quot; : [ {
    &quot;Sid&quot; : &quot;Enable IAM User Permissions&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:root&quot;
    },
    &quot;Action&quot; : &quot;kms:*&quot;,
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow access for Key Administrators&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:user/myadminuser&quot;
    },
    &quot;Action&quot; : [ &quot;kms:Describe*&quot;, &quot;kms:List*&quot;, &quot;kms:Create*&quot;, &quot;kms:Revoke*&quot;,
&quot;kms:Enable*&quot;, &quot;kms:Get*&quot;, &quot;kms:Disable*&quot;, &quot;kms:Delete*&quot;, &quot;kms:Put*&quot;,
&quot;kms:Update*&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow use of the key&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:role/confidant-production&quot;
    },
    &quot;Action&quot; : [ &quot;kms:Decrypt&quot;, &quot;kms:GenerateDataKey*&quot;, &quot;kms:ReEncrypt*&quot;,
&quot;kms:DescribeKey&quot;, &quot;kms:Encrypt&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  }, {
    &quot;Sid&quot; : &quot;Allow attachment of persistent resources&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : {
      &quot;AWS&quot; : &quot;arn:aws:iam::12345:role/confidant-production&quot;
    },
    &quot;Action&quot; : [ &quot;kms:ListGrants&quot;, &quot;kms:CreateGrant&quot;, &quot;kms:RevokeGrant&quot; ],
    &quot;Resource&quot; : &quot;*&quot;
  } ]
}
</code></pre>

<h2 id="confidant-iam-role-configuration">Confidant IAM role configuration</h2>

<p>Confidant needs some IAM policies to properly function. Here&#39;s some example
policies, based on the above configuration:</p>

<p>A policy to find instance profiles, so that Confidant can know which IAM roles
exist. This is to make it easier for users to find which services they can
create.</p>

<pre><code class="json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Action&quot;: [
                &quot;iam:ListRoles&quot;,
                &quot;iam:GetRole&quot;
            ],
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Resource&quot;: &quot;*&quot;
        }
    ]
}
</code></pre>

<p>Allow Confidant to generate random data from KMS:</p>

<pre><code class="json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Action&quot;: [
                &quot;kms:GenerateRandom&quot;
            ],
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Resource&quot;: &quot;*&quot;
        }
    ]
}
</code></pre>

<p>Allow Confidant access to its DynamoDB table. We restrict DeleteTable access,
because the application should never be able to do that.</p>

<pre><code class="json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Action&quot;: [
                &quot;dynamodb:*&quot;
            ],
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Resource&quot;: [
                &quot;arn:aws:dynamodb:*:*:table/confidant-production&quot;,
                &quot;arn:aws:dynamodb:*:*:table/confidant-production/*&quot;
            ]
        },
        {
            &quot;Action&quot;: [
                &quot;dynamodb:DeleteTable&quot;
            ],
            &quot;Effect&quot;: &quot;Deny&quot;,
            &quot;Resource&quot;: [
                &quot;arn:aws:dynamodb:*:*:table/confidant-production&quot;
            ]
        }
    ]
}
</code></pre>

<h2 id="confidant-dynamodb-table-configuration">Confidant DynamoDB table configuration</h2>

<p>You&#39;ll need to create a dynamodb with two global indexes:</p>

<pre><code>hash id: id
hash key data type: S

global indexes:

data_type_date_index:
  hash key: data_type
  hash key data type: S
  range key: modified_date
  range key data type: S

data_type_revision_index:
  hash key: data_type
  hash key data type: S
  range key: revision
  range key data type: N
</code></pre>

<p>Provisioned read/write units can be relative low on both the primary table and
the indexes. See your usage in cloudwatch and increase throughput as necessary.</p>

    </main>
  </div>

    <footer class="footer" data-waypoint="footer" role="contentinfo">
  <div class="wrap-container">
    <div class="footer-column">
      <article class="footer-site-information">
        <p>
          &copy; 2014&ndash;2017 Lyft, Inc
        </p>
      </article>
      <article class="footer-contact">
        <ul class="footer-contact-list">
          <li class="footer-contact-list-item twitter-link">
            <a href="//twitter.com/share" class="twitter-share-button" data-text="Confidant, your secret keeper" data-via="lyft" data-count="none">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

          </li>
          <li class="footer-contact-list-item github-link">
            <iframe src="//ghbtns.com/github-btn.html?user=lyft&repo=confidant&type=watch" height="30" width="70" frameborder="0" scrolling="0" style="width:70px; height: 30px;" class="github-btn" allowTransparency="true"></iframe>

          </li>
          <li class="footer-contact-list-item">
            <a href="//www.lyft.com/app">Download the Lyft app</a>
          </li>
        </ul>
      </article>
    </div>
    <div class="footer-column footer-right">
      <p class="footer-credit">
        From the developers at
      </p>
      <a href="//lyft.com" target="_blank">
        <span class="footer-logo"></span>
      </a>
    </div>
  </div>
</footer>

    <script src="../../javascripts/site-c8d66733.js" type="text/javascript"></script>
    <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1446928-11']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>

  </body>
</html>
